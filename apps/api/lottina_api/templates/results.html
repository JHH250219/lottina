{% extends "base.html" %}
{% block title %}Ergebnisse – lottina{% endblock %}

{% macro filter_panel() %}
  <form method="get" class="space-y-6">
    <div class="space-y-2">
      <label for="filter-q" class="text-xs font-semibold uppercase tracking-[0.3em] text-lottina-primary/70">Suche</label>
      <input id="filter-q"
             name="q"
             value="{{ request.args.get('q','') }}"
             type="text"
             placeholder="z. B. Flohmarkt, Coding Workshop …"
             class="w-full rounded-2xl border border-lottina-primary/15 bg-lottina-background px-4 py-2.5 text-sm text-lottina-primary placeholder:text-lottina-primary/40 focus:border-lottina-accent focus:ring-2 focus:ring-lottina-accent">
    </div>

    <div class="space-y-2">
      <label for="filter-date" class="text-xs font-semibold uppercase tracking-[0.3em] text-lottina-primary/70">Datum</label>
      <input id="filter-date"
             name="date"
             value="{{ request.args.get('date','') }}"
             type="date"
             class="w-full rounded-2xl border border-lottina-primary/15 bg-lottina-background px-4 py-2.5 text-sm text-lottina-primary focus:border-lottina-accent focus:ring-2 focus:ring-lottina-accent">
    </div>

    {% if categories %}
    <div class="space-y-2">
      <div class="flex items-center justify-between text-xs font-semibold uppercase tracking-[0.3em] text-lottina-primary/60">
        <span>Kategorien</span>
        <span class="text-[0.6rem] text-lottina-primary/40">Mehrfach möglich</span>
      </div>
      <div class="rounded-3xl border border-lottina-primary/10 bg-white p-3 max-h-48 overflow-y-auto space-y-2">
        {% for cat in categories %}
          <label class="flex items-center gap-2 text-sm text-lottina-primary/80">
            <input type="checkbox"
                   name="cats[]"
                   value="{{ cat }}"
                   class="rounded text-lottina-accent focus:ring-lottina-accent"
                   {% if cat in active_cats %}checked{% endif %}>
            <span>{{ cat }}</span>
          </label>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <div class="space-y-2">
      <p class="text-xs font-semibold uppercase tracking-[0.3em] text-lottina-primary/70">Highlights</p>
      <div class="rounded-3xl border border-lottina-primary/10 bg-white p-3 space-y-2 text-sm text-lottina-primary">
        <label class="flex items-center gap-2">
          <input type="checkbox" name="free" value="1"
                 class="rounded text-lottina-accent focus:ring-lottina-accent"
                 {% if request.args.get('free') == '1' %}checked{% endif %}>
          Kostenlos
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" name="outdoor" value="1"
                 class="rounded text-lottina-accent focus:ring-lottina-accent"
                 {% if request.args.get('outdoor') == '1' %}checked{% endif %}>
          Outdoor
        </label>
        <label class="flex items-center gap-2">
          <input type="checkbox" name="always" value="1"
                 class="rounded text-lottina-accent focus:ring-lottina-accent"
                 {% if request.args.get('always') == '1' %}checked{% endif %}>
          Immer offen
        </label>
      </div>
    </div>

    <div class="flex gap-2 pt-2">
      <button type="submit"
              class="flex-1 inline-flex items-center justify-center gap-2 rounded-2xl bg-lottina-accent px-4 py-2 text-sm font-semibold text-white shadow hover:-translate-y-0.5 transition">
        Anwenden
      </button>
      <a href="{{ url_for('suchergebnisse') }}"
         class="flex-1 inline-flex items-center justify-center rounded-2xl border border-lottina-primary/15 px-4 py-2 text-sm font-semibold text-lottina-primary/70 hover:border-lottina-primary/40 transition">
        Reset
      </a>
    </div>
  </form>
{% endmacro %}

{% block content %}
{% set active_cats = request.args.getlist('cats[]') %}
{% set has_active_filters = active_cats
    or request.args.get('free') == '1'
    or request.args.get('outdoor') == '1'
    or request.args.get('always') == '1'
    or request.args.get('q')
    or request.args.get('date') %}
{% set summary = [] %}
{% if request.args.get('date') %}
  {% set _ = summary.append("am " ~ request.args.get('date')) %}
{% endif %}
{% if active_cats %}
  {% set _ = summary.append(active_cats|join(", ")) %}
{% endif %}
{% if request.args.get('free') == '1' %}
  {% set _ = summary.append("kostenlos") %}
{% endif %}
{% if request.args.get('outdoor') == '1' %}
  {% set _ = summary.append("Outdoor") %}
{% endif %}
{% if request.args.get('always') == '1' %}
  {% set _ = summary.append("immer offen") %}
{% endif %}

<section class="relative overflow-hidden bg-gradient-to-br from-[#0f2f2c] via-[#155240] to-[#8be84f] text-white">
  <div class="absolute inset-0 opacity-20 pointer-events-none bg-[radial-gradient(circle_at_top,_rgba(255,255,255,0.35),_rgba(0,0,0,0))]"></div>
  <div class="relative z-10 max-w-6xl mx-auto px-6 lg:px-10 py-20 space-y-8">
    <div class="space-y-4">
      <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/15 text-xs uppercase tracking-[0.3em] font-semibold">
        Suchergebnisse
      </span>
      <div class="space-y-2">
        <h1 class="text-3xl md:text-4xl font-lottina font-bold leading-tight drop-shadow">
          {{ request.args.get('q') or "Alle Familien-Events" }}
        </h1>
        <p class="text-sm md:text-base text-white/80 max-w-3xl">
          Nutze Filter, um genau die passenden Events zu finden. Wir zeigen dir Ergebnisse in Echtzeit – kuratiert und werbefrei.
        </p>
      </div>
      <div class="flex flex-wrap gap-3 text-sm">
        <span class="inline-flex items-center gap-2 px-4 py-2 rounded-2xl bg-white/15 border border-white/25">
          <span class="inline-flex h-2 w-2 rounded-full bg-lottina-accent"></span>
          {{ events|length }} Ergebnisse{% if summary %} · {{ summary|join(" · ") }}{% endif %}
        </span>
        {% if has_active_filters %}
          <a href="{{ url_for('suchergebnisse') }}"
             class="inline-flex items-center gap-2 px-4 py-2 rounded-2xl border border-white/35 text-sm font-semibold text-white/90 hover:bg-white/10 transition">
            Reset
          </a>
        {% endif %}
        <button type="button"
                id="mobileFilterToggle"
                class="inline-flex items-center gap-2 px-4 py-2 rounded-2xl border border-white/35 text-sm font-semibold text-white/90 hover:bg-white/10 transition lg:hidden">
          Filter öffnen
        </button>
      </div>
    </div>

    {% if has_active_filters %}
      <div class="flex flex-wrap gap-2 text-xs">
        {% for cat in active_cats %}
          <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/15 border border-white/25 text-white/85">
            {{ cat }}
          </span>
        {% endfor %}
        {% if request.args.get('date') %}
          <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/15 border border-white/25 text-white/85">
            {{ request.args.get('date') }}
          </span>
        {% endif %}
        {% if request.args.get('free') == '1' %}
          <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/15 border border-white/25 text-white/85">
            Kostenlos
          </span>
        {% endif %}
        {% if request.args.get('outdoor') == '1' %}
          <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/15 border border-white/25 text-white/85">
            Outdoor
          </span>
        {% endif %}
        {% if request.args.get('always') == '1' %}
          <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/15 border border-white/25 text-white/85">
            Immer offen
          </span>
        {% endif %}
      </div>
    {% endif %}
  </div>
</section>

<div class="bg-[#f6fbf8] py-12">
  <div class="max-w-6xl mx-auto px-6 lg:px-10 grid gap-8 lg:grid-cols-[280px,1fr]">
    <aside class="hidden lg:block">
      <div class="rounded-3xl border border-lottina-primary/10 bg-white p-6 shadow-lg">
        {{ filter_panel() }}
      </div>
    </aside>

    <section class="space-y-6">
      {% if events %}
        <div class="grid gap-6 md:grid-cols-2">
          {% for event in events %}
            <article class="relative flex flex-col overflow-hidden rounded-3xl border border-lottina-primary/10 bg-white shadow-lg">
              <a href="/event/{{ event.id }}" class="flex flex-col h-full">
                <div class="relative h-48 overflow-hidden">
                  <img src="{{ event.image or url_for('static', filename='img/oma-paper-512.png') }}"
                       alt="{{ event.title or 'Event Bild' }}"
                       class="w-full h-full object-cover transition-transform duration-300 hover:scale-105">
                  <div class="absolute top-3 left-3 inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/90 text-xs font-semibold text-lottina-primary shadow">
                    {% if event.dt_start %}
                      {{ event.dt_start.astimezone().strftime("%a, %d.%m.") }}
                    {% else %}
                      Termin folgt
                    {% endif %}
                  </div>
                </div>
                <div class="p-5 space-y-3 flex-1 flex flex-col">
                  <div class="flex items-center gap-2 text-[0.7rem] uppercase tracking-[0.18em] text-lottina-primary/60">
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-lottina-accent/15 text-lottina-primary font-semibold">
                      {{ event.categories[0].name if event.categories else 'Event' }}
                    </span>
                    {% if event.duration %}
                      <span>{{ event.duration }}</span>
                    {% endif %}
                  </div>
                  <h3 class="text-lg font-semibold leading-snug text-lottina-primary">
                    {{ event.title or "Event ohne Titel" }}
                  </h3>
                  <p class="text-sm text-lottina-primary/70 line-clamp-3">
                    {{ event.description or event.summary or "Mehr Details auf der Eventseite." }}
                  </p>
                  <div class="mt-auto flex flex-wrap gap-2 text-xs text-lottina-primary/70">
                    {% if event.location %}
                      <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-lottina-primary/5 border border-lottina-primary/10">
                        {{ event.location }}
                      </span>
                    {% endif %}
                    {% if event.categories %}
                      {% for c in event.categories[:2] %}
                        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-lottina-primary/5 border border-lottina-primary/10">
                          {{ c.name }}
                        </span>
                      {% endfor %}
                    {% endif %}
                  </div>
                </div>
              </a>
            </article>
          {% endfor %}
        </div>
      {% else %}
        <div class="rounded-3xl border border-lottina-primary/10 bg-white p-8 text-center shadow">
          <p class="text-lg font-semibold text-lottina-primary">Keine Ergebnisse gefunden.</p>
          <p class="text-sm text-lottina-primary/70 mt-2">Probier andere Filterkombinationen oder lade ein neues Event hoch.</p>
          <div class="mt-4 flex flex-wrap gap-3 justify-center text-sm">
            <a href="{{ url_for('suchergebnisse') }}" class="inline-flex items-center gap-2 rounded-2xl border border-lottina-primary/20 px-4 py-2 text-lottina-primary font-semibold">
              Filter zurücksetzen
            </a>
            <a href="{{ url_for('event_erstellen') }}" class="inline-flex items-center gap-2 rounded-2xl bg-lottina-accent px-4 py-2 text-white font-semibold shadow hover:-translate-y-0.5 transition">
              Neues Event einreichen
            </a>
          </div>
        </div>
      {% endif %}
    </section>
  </div>
</div>

<!-- Mobile Drawer -->
<div id="mobileFilterDrawer" class="fixed inset-0 z-[70] hidden lg:hidden">
  <div class="absolute inset-0 bg-black/50"></div>
  <div class="absolute inset-x-0 bottom-0 bg-white rounded-t-3xl p-6 shadow-2xl space-y-4">
    <div class="flex items-center justify-between">
      <p class="text-sm font-semibold text-lottina-primary">Filter</p>
      <button type="button" id="mobileFilterClose" class="rounded-full border border-lottina-primary/10 p-2 text-lottina-primary hover:bg-lottina-primary/5 transition">
        Schließen
      </button>
    </div>
    {{ filter_panel() }}
  </div>
</div>

<script>
  (function() {
    const drawer = document.getElementById("mobileFilterDrawer");
    const openBtn = document.getElementById("mobileFilterToggle");
    const closeBtn = document.getElementById("mobileFilterClose");
    const backdrop = drawer?.querySelector("div");

    const openDrawer = () => drawer?.classList.remove("hidden");
    const closeDrawer = () => drawer?.classList.add("hidden");

    openBtn?.addEventListener("click", openDrawer);
    closeBtn?.addEventListener("click", closeDrawer);
    backdrop?.addEventListener("click", closeDrawer);
  })();
</script>
{% endblock %}
