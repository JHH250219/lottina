{% extends "base.html" %}
{% block title %}Ergebnisse – lottina{% endblock %}
{% block content %}
<div x-data="filterPage()" class="page-enter max-w-7xl mx-auto px-4 py-8 bg-gradient-to-b from-[#fffafa] to-[#fb5c4f]">

  <!-- Mobile Kopf (Filter öffnen) -->
  <div class="flex items-center justify-between mb-4 lg:hidden">
    <button @click="drawer=true"
            class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 bg-white">
      Filter
    </button>
    <a href="{{ url_for('suchergebnisse') }}"
       class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700">
      Löschen
    </a>
  </div>

  <!-- 5-spaltiges Layout auf Desktop -->
  <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">

    <!-- 1/5: Filter (Sidebar) -->
    <aside class="lg:col-span-1">
      <form method="GET" action="{{ url_for('suchergebnisse') }}"
            class="hidden lg:block sticky top-4 bg-white border border-gray-200 rounded-2xl p-4 space-y-5">

        <!-- Ort / Suchfeld -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Ort / Stichwort</label>
          <input type="text" name="q" value="{{ request.args.get('q','') }}"
                 class="w-full px-3 py-2 rounded-lg border border-gray-300 bg-white text-gray-800"
                 placeholder="z.B. Aachen, Minigolf" />
        </div>

        <!-- Datum -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Datum</label>
          <input type="date" name="date" value="{{ date_filter }}"
                 class="w-full px-3 py-2 rounded-lg border border-gray-300 bg-white text-gray-800" />
        </div>

        <!-- Kategorien mit Suche -->
        <div x-data="{q:'',open:true}">
          <button type="button" @click="open = !open"
                  class="w-full flex items-center justify-between py-2">
            <span class="text-sm font-medium text-gray-700">Kategorien</span>
            <svg :class="open ? 'rotate-180' : ''" class="w-4 h-4 transition-transform" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z"/></svg>
          </button>
          <div x-show="open" class="space-y-2">
            <input x-model="q" type="text" placeholder="Kategorie suchen…"
                   class="w-full px-3 py-2 rounded-lg border border-gray-200 bg-white text-sm">
            <div class="max-h-56 overflow-auto pr-1 space-y-1">
              {% for cat in categories %}
              <label class="flex items-center gap-2 text-sm text-gray-700"
                     x-show="{{ cat| tojson}}.toLowerCase().includes(q.toLowerCase())">
                <input type="checkbox" name="cats[]"
                       value="{{ cat }}"
                       {% if request.args.getlist('cats[]') and (cat in request.args.getlist('cats[]')) %}checked{% endif %}
                       class="rounded text-green-600 focus:ring-green-500">
                <span>{{ cat }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
        </div>

        <!-- Flags -->
        <div class="space-y-2">
          <label class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-200">
            <input type="checkbox" name="free" value="1"
                   {% if request.args.get('free')=='1' %}checked{% endif %}
                   class="rounded text-green-600 focus:ring-green-500">
            Kostenlos
          </label>
          <label class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-200">
            <input type="checkbox" name="outdoor" value="1"
                   {% if request.args.get('outdoor')=='1' %}checked{% endif %}
                   class="rounded text-green-600 focus:ring-green-500">
            Draußen
          </label>
          <label class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-200">
            <input type="checkbox" name="always" value="1"
                   {% if request.args.get('always')=='1' %}checked{% endif %}
                   class="rounded text-green-600 focus:ring-green-500">
            Immer offen
          </label>
        </div>

        <!-- Aktionen -->
        <div class="flex gap-2 pt-2">
          <button type="submit"
                  class="flex-1 py-2 px-4 rounded-lg bg-lottina-accent text-lottina-primary font-semibold hover:opacity-90">
            Anwenden
          </button>
          <a href="{{ url_for('suchergebnisse') }}"
             class="flex-1 text-center py-2 px-4 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300">
            Löschen
          </a>
        </div>

        <!-- Aktive Filter als Chips -->
        {% set active_cats = request.args.getlist('cats[]') %}
        {% if active_cats or request.args.get('free')=='1' or request.args.get('outdoor')=='1' or request.args.get('always')=='1' or request.args.get('q') or date_filter %}
        <div class="pt-3 border-t dark:border-gray-700">
          <p class="text-xs text-gray-500 mb-2">Aktive Filter:</p>
          <div class="flex flex-wrap gap-2">
            {% for c in active_cats %}
              <span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-800">{{ c }}</span>
            {% endfor %}
            {% if request.args.get('free')=='1' %}<span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-800">Kostenlos</span>{% endif %}
            {% if request.args.get('outdoor')=='1' %}<span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-800">Draußen</span>{% endif %}
            {% if request.args.get('always')=='1' %}<span class="px-2 py-1 rounded-full text-xs bg-green-100 text-green-800">Immer offen</span>{% endif %}
          </div>
        </div>
        {% endif %}
      </form>

      <!-- Mobile Drawer -->
      <div x-show="drawer" class="lg:hidden fixed inset-0 z-50">
        <div @click="drawer=false" class="absolute inset-0 bg-black/40"></div>
        <form method="GET" action="{{ url_for('suchergebnisse') }}"
              class="absolute right-0 top-0 bottom-0 w-full max-w-sm bg-[#1f2148] dark:bg-gray-800 p-4 space-y-5 overflow-y-auto">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-lg font-semibold">Filter</h3>
            <button type="button" @click="drawer=false" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">✕</button>
          </div>

          <!-- gleiche Inputs wie Desktop -->
          <div>
            <label class="block text-sm font-medium mb-1">Ort / Stichwort</label>
            <input type="text" name="q" value="{{ request.args.get('q','') }}"
                   class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Datum</label>
            <input type="date" name="date" value="{{ date_filter }}"
                   class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-900">
          </div>
          <div x-data="{q:''}">
            <p class="text-sm font-medium mb-1">Kategorien</p>
            <input x-model="q" type="text" placeholder="Kategorie suchen…"
                   class="w-full px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-900 text-sm mb-2">
            <div class="max-h-64 overflow-auto pr-1 space-y-1">
              {% for cat in categories %}
              <label class="flex items-center gap-2 text-sm"
                     x-show="{{ cat| tojson}}.toLowerCase().includes(q.toLowerCase())">
                <input type="checkbox" name="cats[]"
                       value="{{ cat }}"
                       {% if request.args.getlist('cats[]') and (cat in request.args.getlist('cats[]')) %}checked{% endif %}
                       class="rounded text-green-600 focus:ring-green-500">
                <span>{{ cat }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
          <div class="space-y-2">
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" name="free" value="1" {% if request.args.get('free')=='1' %}checked{% endif %}
                     class="rounded text-green-600 focus:ring-green-500"> Kostenlos
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" name="outdoor" value="1" {% if request.args.get('outdoor')=='1' %}checked{% endif %}
                     class="rounded text-green-600 focus:ring-green-500"> Draußen
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" name="always" value="1" {% if request.args.get('always')=='1' %}checked{% endif %}
                     class="rounded text-green-600 focus:ring-green-500"> Immer offen
            </label>
          </div>
          <div class="flex gap-2 pt-2">
            <button type="submit"
                    class="flex-1 py-2 px-4 rounded-lg bg-lottina-accent text-lottina-primary font-semibold">Anwenden</button>
            <a href="{{ url_for('suchergebnisse') }}"
               class="flex-1 text-white text-center py-2 px-4 rounded-lg border border-gray-300 dark:border-gray-600">Löschen</a>
          </div>
        </form>
      </div>
    </aside>

    <!-- 3/5: Ergebnisse -->
    <section class="lg:col-span-3">
      {% if events %}
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        {% for event in events %}
        <a href="{{ url_for('event_detail', event_id=event.id) }}"

           class="block rounded-xl overflow-hidden bg-lottina-primary shadow hover:shadow-lg transition focus:outline-none focus:ring-2 focus:ring-lottina-primary">
          {% if event.image %}
            <img src="{{ event.image }}" alt="{{ event.title }}" class="w-full h-44 object-cover" />
          {% else %}
            <div class="w-full h-44 bg-gray-200 flex items-center justify-center text-gray-500">
              Kein Bild verfügbar
            </div>
          {% endif %}
          <div class="p-4">
            <h2 class="text-lg font-bold text-lottina-white mb-1">{{ event.title }}</h2>
            <p class="text-sm text-white mb-2">
              {{ event.dt_start | smartdate }}
              –
              {{ (event.location.address if event.location and event.location.address else (event.location.name if event.location else "Ort unbekannt")) }}
            </p>
            <p class="text-sm text-white/90 line-clamp-3 mb-3">{{ event.description }}</p>
            <div class="flex flex-wrap gap-2 text-xs text-white">
              {% if event.is_free %}
                <span class="bg-green-500 rounded-full px-2 py-1">Kostenlos</span>
              {% elif event.price_value %}
                <span class="bg-purple-600 rounded-full px-2 py-1">{{ event.price_value|euro }} €</span>
              {% endif %}


              {# optional flags, wenn du sie später in der DB hast #}
              {# {% if event.is_outdoor %}<span class="bg-blue-500 rounded-full px-2 py-1">Draußen</span>{% endif %} #}

              {% if event.categories %}
                {% for c in event.categories[:2] %}
                  <span class="bg-yellow-600 rounded-full px-2 py-1">{{ c.name }}</span>
                {% endfor %}
              {% endif %}

            </div>
          </div>
        </a>
        {% endfor %}
      </div>
      {% else %}
        <p class="text-gray-600">Keine Veranstaltungen gefunden.</p>
      {% endif %}
    </section>

    <!-- 1/5: Karte -->
    <aside class="lg:col-span-1">
      <div class="sticky top-4">
        <div id="result-map" class="w-full h-[540px] rounded-xl shadow border border-gray-200"></div>
        <!-- Datenquelle für Marker -->
        <script id="coords-data" type="application/json">
  {{ coords | tojson | safe }}
</script>
<script>
  // JSON aus dem Script-Tag holen
  const RESULTS_WITH_COORDS = JSON.parse(
    document.getElementById('coords-data').textContent
  );

  // Debug-Check
  console.log("Koordinaten geladen:", RESULTS_WITH_COORDS);
</script>



      </div>
    </aside>

  </div> <!-- /grid -->

</div> <!-- /container -->

<script>
  function filterPage(){ return { drawer:false } }

  // Leaflet Map rechts (1/5)
  document.addEventListener('DOMContentLoaded', () => {
    const el = document.getElementById('result-map');
    if (!el) return;

    const map = L.map(el).setView([51.1657, 10.4515], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap',
      maxZoom: 18,
    }).addTo(map);

    const icon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-violet.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });

    const markers = [];
    (RESULTS_WITH_COORDS || []).forEach(ev => {
      const m = L.marker([ev.lat, ev.lon], {icon}).addTo(map)
        .bindPopup(`<strong>${ev.title}</strong><br>${ev.date}<br><a href="/event/${ev.url}" class="underline">Details</a>`);
      markers.push(m);
    });

    if (markers.length) {
      const group = L.featureGroup(markers);
      map.fitBounds(group.getBounds(), {padding: [20, 20]});
    }
  });
</script>
{% endblock %}
