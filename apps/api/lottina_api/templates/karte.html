{% extends "base.html" %}
{% block title %}Karte – lottina{% endblock %}

{% block content %}
<div class="page-enter pt-40 pb-16 min-h-screen text-lottina-primary bg-gradient-to-b from-[#e8f9f2] via-lottina-background to-[#f4fdf8]">
  <div class="w-full px-4 sm:px-8 lg:px-12 space-y-8">
    <header class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-6">
      <div class="space-y-3">
        <p class="text-xs uppercase tracking-[0.24em] text-lottina-primary/70 font-semibold">
          Entdecke kinderfreundliche Orte
        </p>
        <h1 class="text-3xl font-lottina font-bold leading-tight drop-shadow">
          Interaktive Karte
        </h1>
        <p class="text-sm md:text-base text-lottina-primary/80 max-w-3xl">
          Zoome dich durch unsere spielerische Deutschland-Karte. Filtere nach Kategorien, zeige nur Spielplätze
          oder entdecke neue Dauerangebote für Familien.
        </p>
      </div>
      <div class="inline-flex items-center gap-3 px-5 py-3 rounded-2xl bg-white border border-lottina-primary/10 shadow-sm text-sm text-lottina-primary/80">
        <span class="inline-flex h-2 w-2 rounded-full bg-lottina-accent"></span>
        <span><strong id="karte-count" class="font-semibold text-lottina-primary">{{ total }}</strong> Orte auf der Karte</span>
      </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-6 gap-6 min-h-[70vh]">
      <!-- Filter Sidebar -->
      <aside class="lg:col-span-1">
        <div class="sticky top-24">
          <div class="bg-white border border-lottina-primary/10 shadow-md rounded-3xl px-5 py-6 space-y-6">
            <div class="space-y-1">
              <h2 class="text-lg font-semibold text-lottina-primary">Kategorie-Tools</h2>
              <p class="text-sm text-lottina-primary/70">
                Blende Kategorien ein oder aus und entdecke ganz gezielt passende Angebote.
              </p>
            </div>

            <div class="flex flex-wrap gap-2">
              <button type="button"
                      data-action="playground-only"
                      class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-emerald-300 bg-emerald-50 text-emerald-700 text-sm font-semibold hover:bg-emerald-100 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 12h16M12 4v16" />
                </svg>
                Nur Spielplätze
              </button>
              <button type="button"
                      data-action="reset-filters"
                      class="inline-flex items-center gap-2 px-3 py-2 rounded-xl border border-gray-200 text-sm text-lottina-primary/70 hover:bg-gray-50 transition">
                Alles anzeigen
              </button>
            </div>

            <div class="border-t border-lottina-primary/10 pt-4">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-semibold text-lottina-primary uppercase tracking-[0.14em]">Kategorien</h3>
                <span class="text-xs text-lottina-primary/50">Scroll für mehr</span>
              </div>
              <div class="max-h-72 overflow-y-auto pr-1 space-y-2">
                {% for cat in category_filters %}
                  <label class="flex items-center gap-3 px-3 py-2 rounded-2xl border border-transparent hover:border-lottina-accent/40 hover:bg-lottina-accent/10 transition select-none">
                    <input type="checkbox"
                           name="category-filter"
                           value="{{ cat.slug }}"
                           class="rounded text-lottina-accent focus:ring-lottina-accent"
                           checked>
                    <span class="text-sm text-lottina-primary">{{ cat.name }}</span>
                  </label>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- Map Section -->
      <section class="lg:col-span-5">
        <div class="bg-white border border-lottina-primary/10 rounded-[32px] shadow-xl overflow-hidden h-full flex flex-col">
          <div class="flex items-center justify-between px-6 py-4 border-b border-lottina-primary/10">
            <div class="space-y-1">
              <h2 class="text-lg font-semibold text-lottina-primary">Karte</h2>
              <p class="text-xs text-lottina-primary/60">Klicke auf einen Pin, um mehr zu erfahren und direkt zur Detailseite zu springen.</p>
            </div>
            <div class="flex items-center gap-2 text-xs text-lottina-primary/60">
              <span class="inline-flex items-center gap-1">
                <span class="inline-block h-3 w-3 rounded-full bg-emerald-400 shadow"></span>
                Spielplatz
              </span>
              <span class="inline-flex items-center gap-1">
                <span class="inline-block h-3 w-3 rounded-full bg-[#2563eb] shadow"></span>
                Weitere Angebote
              </span>
            </div>
          </div>
          <div class="flex-1 relative">
            <div id="karte-map" class="absolute inset-0"></div>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>

<script id="karte-data" type="application/json">{{ coords | tojson | safe }}</script>
<script id="karte-categories" type="application/json">{{ category_filters | tojson | safe }}</script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const mapEl = document.getElementById('karte-map');
    const dataEl = document.getElementById('karte-data');
    if (!mapEl || !dataEl || typeof L === 'undefined') return;

    let points = [];
    try {
      points = JSON.parse(dataEl.textContent || '[]');
    } catch (err) {
      console.warn('Karten-Daten konnten nicht geparst werden', err);
      points = [];
    }

    const map = L.map(mapEl, {
      zoomControl: true,
    }).setView([51.1657, 10.4515], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap-Mitwirkende',
      maxZoom: 18,
    }).addTo(map);

    const defaultIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41],
    });

    const playgroundIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41],
    });

    const escapeHtml = (value) => String(value ?? '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');

    const markerGroup = L.layerGroup().addTo(map);
    const markerEntries = [];

    points.forEach((point) => {
      if (typeof point.lat !== 'number' || typeof point.lon !== 'number') return;
      const marker = L.marker([point.lat, point.lon], {
        icon: point.is_playground ? playgroundIcon : defaultIcon,
      });

      const locationParts = [];
      if (point.location_name) {
        locationParts.push(escapeHtml(point.location_name));
      }
      if (point.address) {
        locationParts.push(escapeHtml(point.address));
      }

      const categories = (point.category_labels || []).map(label => `<span style="display:inline-block;margin-right:6px;margin-bottom:4px;padding:2px 8px;border-radius:999px;background:#e0f2fe;color:#1d4ed8;font-size:0.7rem;font-weight:600;">${escapeHtml(label)}</span>`).join('');

      const metaLine = point.is_permanent ? 'Immer offen' : 'Termin folgt';

      const popupHtml = `
        <div style="min-width:220px;font-family:'Fredoka',sans-serif;">
          ${point.is_playground ? '<span style="display:inline-block;margin-bottom:6px;padding:2px 10px;border-radius:999px;background:#d1fae5;color:#047857;font-size:0.7rem;font-weight:600;">Spielplatz</span>' : ''}
          <div style="font-weight:600;font-size:1rem;color:#102a43;">${escapeHtml(point.title || 'Ohne Titel')}</div>
          ${locationParts.length ? `<div style="margin-top:6px;font-size:0.85rem;color:#2f3e46;">${locationParts.join('<br>')}</div>` : ''}
          ${categories ? `<div style="margin-top:8px;">${categories}</div>` : ''}
          <div style="margin-top:6px;font-size:0.8rem;color:#4a5568;">${escapeHtml(metaLine)}</div>
          <p style="margin-top:6px;font-size:0.75rem;line-height:1.3;color:#334155;">${escapeHtml(point.summary || '')}</p>
          <a href="${point.url}" style="display:inline-flex;align-items:center;gap:6px;margin-top:10px;color:#0f766e;font-weight:600;text-decoration:none;">
            Details ansehen
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.6">
              <path stroke-linecap="round" stroke-linejoin="round" d="m9 5 7 7-7 7" />
            </svg>
          </a>
        </div>
      `;

      marker.bindPopup(popupHtml, { minWidth: 240 });

      markerEntries.push({
        marker,
        point,
        categories: new Set(point.categories || []),
      });

      marker.addTo(markerGroup);
    });

    const fitToVisibleMarkers = (visibleEntries) => {
      if (!visibleEntries.length) return;
      if (visibleEntries.length === 1) {
        map.setView(visibleEntries[0].marker.getLatLng(), 14);
        return;
      }
      const group = L.featureGroup(visibleEntries.map(entry => entry.marker));
      map.fitBounds(group.getBounds(), { padding: [24, 24] });
    };

    if (markerEntries.length) {
      fitToVisibleMarkers(markerEntries);
    }

    const countEl = document.getElementById('karte-count');
    const playgroundButton = document.querySelector('[data-action="playground-only"]');
    const resetButton = document.querySelector('[data-action="reset-filters"]');
    const filterInputs = Array.from(document.querySelectorAll('input[name="category-filter"]'));

    let playgroundOnly = false;

    const applyFilters = ({ autoFit = false } = {}) => {
      const activeSlugs = filterInputs
        .filter(input => input.checked)
        .map(input => input.value);
      const activeSet = activeSlugs.length ? new Set(activeSlugs) : null;

      const visibleEntries = [];
      markerEntries.forEach((entry) => {
        const matchesCategory = !activeSet || entry.categories.size === 0 || [...entry.categories].some(slug => activeSet.has(slug));
        const matchesPlayground = !playgroundOnly || entry.point.is_playground;

        if (matchesCategory && matchesPlayground) {
          if (!markerGroup.hasLayer(entry.marker)) {
            markerGroup.addLayer(entry.marker);
          }
          visibleEntries.push(entry);
        } else if (markerGroup.hasLayer(entry.marker)) {
          markerGroup.removeLayer(entry.marker);
        }
      });

      if (countEl) {
        countEl.textContent = visibleEntries.length.toString();
      }

      if (autoFit && visibleEntries.length) {
        fitToVisibleMarkers(visibleEntries);
      }
    };

    filterInputs.forEach((input) => {
      input.addEventListener('change', () => applyFilters({ autoFit: true }));
    });

    playgroundButton?.addEventListener('click', () => {
      playgroundOnly = !playgroundOnly;
      playgroundButton.classList.toggle('bg-emerald-50', !playgroundOnly);
      playgroundButton.classList.toggle('bg-emerald-500', playgroundOnly);
      playgroundButton.classList.toggle('text-white', playgroundOnly);
      playgroundButton.classList.toggle('border-emerald-300', !playgroundOnly);
      playgroundButton.classList.toggle('border-emerald-600', playgroundOnly);
      playgroundButton.querySelector('svg')?.classList.toggle('text-white', playgroundOnly);
      applyFilters({ autoFit: true });
    });

    resetButton?.addEventListener('click', () => {
      playgroundOnly = false;
      playgroundButton?.classList.remove('bg-emerald-500', 'text-white', 'border-emerald-600');
      playgroundButton?.classList.add('bg-emerald-50', 'text-emerald-700', 'border-emerald-300');
      filterInputs.forEach((input) => { input.checked = true; });
      applyFilters({ autoFit: true });
    });
  });
</script>
{% endblock %}
