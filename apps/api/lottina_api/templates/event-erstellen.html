{% extends "base.html" %}
{% block title %}Event erstellen – lottina{% endblock %}

{% block content %}
<section class="relative overflow-hidden bg-gradient-to-br from-[#1f2148] via-[#2b245c] to-[#fb5c4f] text-white">
  <div class="absolute inset-0 opacity-20 bg-[radial-gradient(circle_at_top,_rgba(255,255,255,0.3),_rgba(0,0,0,0))] pointer-events-none"></div>
  <div class="relative z-10 max-w-4xl mx-auto px-6 lg:px-10 py-16 space-y-6">
    <h1 class="text-3xl sm:text-4xl lg:text-5xl font-lottina font-bold leading-tight drop-shadow-lg">
      Event erstellen
    </h1>
    <p class="text-base sm:text-lg text-white/80 max-w-2xl">
      Trage dein Event manuell ein oder nutze unsere OCR, um Poster und PDFs automatisch erfassen zu lassen. In wenigen Minuten ist dein Erlebnis für Familien sichtbar.
    </p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="choiceBox">
      <button id="startManual" type="button"
              class="group relative overflow-hidden rounded-3xl border border-white/20 bg-white/90 text-lottina-primary px-6 py-6 sm:py-8 shadow-xl transition transform hover:-translate-y-1">
        <div class="flex items-start justify-between gap-4">
          <div class="space-y-2 text-left">
            <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-[#fef4f1] text-xs font-semibold text-[#fb5c4f] uppercase tracking-wide">
              Schritt für Schritt
            </span>
            <p class="text-lg font-semibold">Manuell anlegen</p>
            <p class="text-sm text-lottina-primary/70 max-w-xs">
              Ideal, wenn du Details ergänzen möchtest oder noch kein Poster vorliegen hast.
            </p>
          </div>
          <span class="flex h-12 w-12 items-center justify-center rounded-full bg-gradient-to-br from-[#fb5c4f] to-[#ff947f] text-white shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </span>
        </div>
      </button>

      <label for="ocrUpload"
             class="group relative overflow-hidden rounded-3xl border border-white/30 bg-gradient-to-br from-[#fb5c4f] via-[#ff8c73] to-[#ffd0c1] text-white px-6 py-6 sm:py-8 shadow-xl cursor-pointer transition transform hover:-translate-y-1">
        <div class="flex items-start justify-between gap-4">
          <div class="space-y-2 text-left">
            <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/20 text-xs font-semibold uppercase tracking-wide">
              OCR · Beta
            </span>
            <p class="text-lg font-semibold">Poster scannen (OCR)</p>
            <p class="text-sm text-white/85 max-w-xs">
              Foto oder PDF hochladen – lottina erkennt Datum, Ort, Kontakt & mehr automatisch.
            </p>
          </div>
          <span class="flex h-12 w-12 items-center justify-center rounded-full bg-white/15 text-white shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7h2l2-3h10l2 3h2a2 2 0 012 2v10a2 2 0 01-2 2H3a2 2 0 01-2-2V9a2 2 0 012-2z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 13a3 3 0 100-6 3 3 0 000 6z"/>
            </svg>
          </span>
        </div>
        <input type="file" id="ocrUpload" accept="image/*,application/pdf" class="hidden" />
      </label>
    </div>

    <div class="grid gap-3 sm:grid-cols-3 text-sm text-white/75">
      <div class="flex items-center gap-2">
        <span class="h-2.5 w-2.5 rounded-full bg-white/60"></span>
        Poster & PDFs bis 12&nbsp;MB
      </div>
      <div class="flex items-center gap-2">
        <span class="h-2.5 w-2.5 rounded-full bg-white/60"></span>
        OCR für deutschsprachige Inhalte optimiert
      </div>
      <div class="flex items-center gap-2">
        <span class="h-2.5 w-2.5 rounded-full bg-white/60"></span>
        Manuelle Korrektur jederzeit möglich
      </div>
    </div>
  </div>
</section>

<section class="bg-[#fef8f6]">
  <div class="max-w-4xl mx-auto px-6 lg:px-10 py-12">
    
      <div id="ocrPanel" class="hidden rounded-2xl border border-[#fb5c4f]/25 bg-[#fff1ec] px-5 py-4 shadow-lg">
        <div class="flex items-center justify-between gap-3">
          <div class="text-lottina-primary font-semibold">OCR-Ergebnis</div>
          <div id="ocrConf" class="text-xs text-lottina-primary/60"></div>
        </div>
        <div id="ocrStatus" class="mt-2 text-sm text-lottina-primary/80"></div>
      </div>

      <form id="eventForm" method="POST" action="/event-erstellen" enctype="multipart/form-data" class="text-lottina-primary hidden space-y-10">

        <div class="step space-y-6 bg-[#fef3ef] border border-[#fb5c4f]/20 rounded-2xl p-6" data-step="1">
          <div>
            <label class="block text-lottina-primary font-semibold mb-2">Event-Titel</label>
            <input type="text" id="title" name="title" required class="w-full p-3 rounded-lg border border-white focus:border-[#fb5c4f] focus:ring-2 focus:ring-[#fb5c4f]/40" placeholder="z. B. Familien-Flohmarkt im Stadtpark">
          </div>
          <div>
            <label class="block text-lottina-primary font-semibold mb-2">Beschreibung (optional)</label>
            <textarea id="description" name="description" rows="4" class="w-full p-3 rounded-lg border border-white focus:border-[#fb5c4f] focus:ring-2 focus:ring-[#fb5c4f]/40" placeholder="Kurzbeschreibung …"></textarea>
          </div>
        </div>

        <div class="step hidden space-y-6 bg-[#fef3ef] border border-[#fb5c4f]/20 rounded-2xl p-6" data-step="2">
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div>
              <label class="block text-lottina-primary font-semibold mb-2">Datum</label>
              <input type="date" id="date" name="date" required class="w-full p-3 rounded-lg border border-white focus:border-[#fb5c4f] focus:ring-2 focus:ring-[#fb5c4f]/40">
            </div>
            <div>
              <label class="block text-lottina-primary font-semibold mb-2">Startzeit (optional)</label>
              <input type="time" id="time" name="time" class="w-full p-3 rounded-lg border border-white focus:border-[#fb5c4f] focus:ring-2 focus:ring-[#fb5c4f]/40">
            </div>
            <div>
              <label class="block text-lottina-primary font-semibold mb-2">Endzeit (optional)</label>
              <input type="time" id="time_end" name="time_end" class="w-full p-3 rounded-lg border border-white focus:border-[#fb5c4f] focus:ring-2 focus:ring-[#fb5c4f]/40">
            </div>
          </div>
        </div>

        <div class="step hidden space-y-6 bg-[#fef3ef] border border-[#fb5c4f]/20 rounded-2xl p-6" data-step="3">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-lottina-primary font-semibold mb-2">Ort</label>
              <input type="text" id="location" name="location" required class="w-full p-3 rounded-lg border border-white focus:border-[#fb5c4f] focus:ring-2 focus:ring-[#fb5c4f]/40" placeholder="z. B. Stadtpark, Musterstadt">
            </div>
            <div>
              <label class="block text-lottina-primary font-semibold mb-2">Maps-URL (optional)</label>
              <input type="url" id="maps_url" name="maps_url" class="w-full p-3 rounded-lg border border-white focus:border-[#fb5c4f] focus:ring-2 focus:ring-[#fb5c4f]/40" placeholder="https://maps.google.com/...">
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-lottina-primary font-semibold mb-2">Kategorie</label>
              <input type="text" id="category" name="category" class="w-full p-3 rounded-lg border border-white focus:border-[#fb5c4f] focus:ring-2 focus:ring-[#fb5c4f]/40" placeholder="z. B. Konzert, Theater, Familie">
              <div id="categorySuggestions" class="hidden mt-2 text-xs sm:text-sm text-lottina-primary/70 flex flex-wrap gap-2"></div>
            </div>
            <div>
              <label class="block text-lottina-primary font-semibold mb-2">Altersgruppe</label>
              <input type="text" id="age_group" name="age_group" class="w-full p-3 rounded-lg border border-white focus:border-[#fb5c4f] focus:ring-2 focus:ring-[#fb5c4f]/40" placeholder="z. B. ab 6 Jahren">
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-lottina-primary font-semibold mb-2">Kontakt (E-Mail, optional)</label>
              <input type="email" id="contact" name="contact" class="w-full p-3 rounded-lg border border-white focus:border-[#fb5c4f] focus:ring-2 focus:ring-[#fb5c4f]/40" placeholder="kontakt@example.de">
            </div>
            <div>
              <label class="block text-lottina-primary font-semibold mb-2">Anmeldung erforderlich?</label>
              <select id="registration" name="registration" class="w-full p-3 rounded-lg border border-white focus:border-[#fb5c4f] focus:ring-2 focus:ring-[#fb5c4f]/40">
                <option value="">–</option>
                <option value="ja">Ja</option>
                <option value="nein">Nein</option>
              </select>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-lottina-primary font-semibold mb-2">Generelle Öffnungszeiten (optional)</label>
              <textarea id="opening_hours" name="opening_hours" rows="3" class="w-full p-3 rounded-lg border border-white focus:border-[#fb5c4f] focus:ring-2 focus:ring-[#fb5c4f]/40" placeholder="z. B. Mo-Fr 10-18 Uhr, Sa 12-16 Uhr"></textarea>
            </div>
            <div>
              <label class="block text-lottina-primary font-semibold mb-2">Preis / Hinweis (optional)</label>
              <input type="text" id="price_info" name="price_info" class="w-full p-3 rounded-lg border border-white focus:border-[#fb5c4f] focus:ring-2 focus:ring-[#fb5c4f]/40" placeholder="z. B. 5 € p.P. / kostenlos zzgl. Eintritt">
            </div>
          </div>
        </div>

        <div class="step hidden space-y-6 bg-[#fef3ef] border border-[#fb5c4f]/20 rounded-2xl p-6" data-step="4">
          <div id="ocrReview" class="hidden mb-2 p-4 rounded-2xl border border-[#fb5c4f]/25 bg-white shadow-sm">
            <div class="flex items-center justify-between gap-3">
              <div class="text-lottina-primary font-semibold">Autofill-Übersicht</div>
              <div class="text-xs text-gray-500" data-review-stats></div>
            </div>
            <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-3" id="ocrReviewGrid"></div>
          </div>

          <div id="ocrImagePreview" class="hidden">
            <div class="text-sm font-semibold text-lottina-primary mb-2">Bildvorschau</div>
            <div class="preview-img-wrap mx-0 shadow border border-white/40">
              <div class="preview-ar">
                <img id="ocrImagePreviewImg" src="" alt="Vorschau" class="w-full h-full object-contain" />
              </div>
            </div>
          </div>

          <input type="hidden" id="image_url" name="image_url">
        </div>

        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 sm:gap-4">
          <button type="button" id="prevStep" class="px-4 py-2 rounded-xl border border-[#1f2148]/25 bg-white text-[#1f2148] font-semibold shadow-sm w-full sm:w-auto hover:bg-[#1f2148]/10 transition">Zurück</button>
          <div class="flex gap-3 w-full sm:w-auto">
            <button type="button" id="previewBtn" class="px-4 py-2 rounded-xl bg-[#1f2148] text-white font-semibold shadow hover:bg-[#32265f] transition w-full sm:w-auto">Vorschau</button>
            <button type="button" id="nextStep" class="px-4 py-2 rounded-xl bg-gradient-to-r from-[#fb5c4f] to-[#ff947f] text-[#1f2148] font-semibold shadow-lg hover:from-[#ff6b62] hover:to-[#ffb199] transition w-full sm:w-auto">Weiter</button>
            <button type="submit" id="submitEvent" class="hidden px-4 py-2 rounded-xl bg-gradient-to-r from-[#fb5c4f] to-[#ff947f] text-[#1f2148] font-semibold shadow-lg hover:from-[#ff6b62] hover:to-[#ffb199] transition w-full sm:w-auto">Event speichern</button>
          </div>
        </div>
      </form>
  </div>
</section>

<!-- Vorschau-Modal -->
<div id="previewModal" class="hidden fixed inset-0 z-50">
  <div class="absolute inset-0 bg-black/50"></div>
  <div class="relative max-w-3xl mx-auto my-10 bg-white dark:bg-gray-900 rounded-2xl shadow-xl overflow-hidden">
    <div class="flex items-center justify-between px-6 py-4 border-b dark:border-gray-700">
      <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Vorschau</h3>
      <button id="closePreview" class="px-3 py-1 rounded-md bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600">Schließen</button>
    </div>

    <div id="previewBody" class="p-6">
      <!-- Dynamisch gefüllt -->
    </div>
  </div>
</div>

<!-- Review-Editor Modal -->
<div id="reviewEditModal" class="hidden fixed inset-0 z-[1100]">
  <div class="absolute inset-0 bg-black/50"></div>
  <div class="relative h-full flex items-center justify-center px-4">
    <div class="pointer-events-auto w-full max-w-lg bg-white rounded-2xl shadow-2xl">
      <div class="flex items-center justify-between border-b px-5 py-3">
        <h3 id="reviewEditTitle" class="text-lg font-semibold text-lottina-primary">Feld bearbeiten</h3>
        <button type="button" id="reviewEditClose" class="text-sm text-gray-500 hover:text-gray-800">Schließen</button>
      </div>
      <div class="px-5 py-4 space-y-3 text-lottina-primary" id="reviewEditBody"></div>
      <div class="flex justify-end gap-2 border-t px-5 py-3 bg-gray-50">
        <button type="button" id="reviewEditCancel" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100">Abbrechen</button>
        <button type="button" id="reviewEditSave" class="px-4 py-2 rounded-lg bg-lottina-primary text-white hover:bg-lottina-accent">Übernehmen</button>
      </div>
    </div>
  </div>
</div>

<!-- OCR Overlay -->
<div id="ocrOverlay" class="fixed inset-0 z-[1000] hidden">
  <div class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>
  <div class="relative h-full flex items-center justify-center pointer-events-none">
    <div class="pointer-events-auto bg-white/90 rounded-2xl shadow-2xl p-6 sm:p-8 flex flex-col items-center gap-4">
      <div class="bubble-loader" aria-hidden="true">
        <span></span><span></span><span></span><span></span><span></span><span></span>
      </div>
      <p id="ocrOverlayMsg" class="text-lottina-primary font-semibold text-center">Erkenne Text…</p>
      <div class="mt-1 h-1 w-48 bg-gray-200 rounded-full overflow-hidden">
        <div class="h-full w-1/3 bg-lottina-primary animate-progress"></div>
      </div>
      <button type="button" id="cancelOcr" class="mt-2 text-xs text-gray-600 hover:text-gray-900 underline">Abbrechen</button>
    </div>
  </div>
</div>

<style>
.dots::after { content: "…"; animation: dots 1.2s steps(4,end) infinite; }
@keyframes dots { 0% {content:""} 25% {content:"."} 50% {content:".."} 75% {content:"..."} 100% {content:""} }
@keyframes progress { 0% {transform: translateX(-120%)} 100% {transform: translateX(300%)} }
.animate-progress { animation: progress 1.2s linear infinite; }
@keyframes lupe { 0% { transform: rotate(0deg) translate(0,0) }
  25% { transform: rotate(8deg) translate(-3px,-2px) }
  50% { transform: rotate(-6deg) translate(2px,1px) }
  75% { transform: rotate(10deg) translate(-2px,2px) }
  100% { transform: rotate(0deg) translate(0,0) } }
.animate-lupe { color: #0ea5e9; animation: lupe 1.4s ease-in-out infinite; }
.preview-img-wrap {
  width: 100%;
  max-width: 360px;
  margin-left: auto;
  margin-right: auto;
  background: #f3f4f6;
  border-radius: 0.75rem;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.4);
}
.preview-ar { aspect-ratio: 9 / 16; }
@supports not (aspect-ratio: 1 / 1) {
  .preview-ar { position: relative; }
  .preview-ar::before {
    content: "";
    display: block;
    padding-top: 177.78%;
  }
  .preview-ar > img {
    position: absolute; inset: 0;
  }
}
.bubble-loader{ display:flex; gap:.6rem; align-items:center; justify-content:center; height:70px; }
.bubble-loader span{
  width:14px; height:14px; border-radius:999px; background:#fb5c4f;
  opacity:.35; animation:bubble 1.2s ease-in-out infinite;
}
.bubble-loader span:nth-child(2){ animation-delay:.1s }
.bubble-loader span:nth-child(3){ animation-delay:.2s }
.bubble-loader span:nth-child(4){ animation-delay:.3s }
.bubble-loader span:nth-child(5){ animation-delay:.4s }
.bubble-loader span:nth-child(6){ animation-delay:.5s }
@keyframes bubble{
  0%,100%{ transform: translateY(6px) scale(.95); opacity:.35 }
  50%    { transform: translateY(-6px) scale(1.05); opacity:1 }
}
</style>

<script>
const choiceBox   = document.getElementById("choiceBox");
const form        = document.getElementById("eventForm");
const steps       = form.querySelectorAll(".step");
const ocrPanel    = document.getElementById("ocrPanel");
const ocrStatus   = document.getElementById("ocrStatus");
const ocrConf     = document.getElementById("ocrConf");
const reviewBox   = document.getElementById("ocrReview");
const reviewGrid  = document.getElementById("ocrReviewGrid");
const reviewStats = document.querySelector("[data-review-stats]");
const categorySuggestions = document.getElementById("categorySuggestions");
const reviewEditModal = document.getElementById("reviewEditModal");
const reviewEditTitle = document.getElementById("reviewEditTitle");
const reviewEditBody  = document.getElementById("reviewEditBody");
const reviewEditSave  = document.getElementById("reviewEditSave");
const reviewEditCancel = document.getElementById("reviewEditCancel");
const reviewEditClose  = document.getElementById("reviewEditClose");
const reviewEditOverlay = reviewEditModal?.querySelector(".absolute");
let activeReviewEdit = null;
let activeReviewDraft = "";
let currentStep = 0;
let reviewEditControl = null;
let reviewEditOriginalEl = null;
let detectedCategories = [];

const OCR_FIELD_LABELS = {
  title: "Titel",
  description: "Beschreibung",
  date: "Datum",
  time: "Startzeit",
  time_end: "Endzeit",
  location: "Ort",
  category: "Kategorie",
  categories: "Kategorien",
  age_group: "Altersgruppe",
  contact: "Kontakt",
  opening_hours: "Öffnungszeiten",
  price_info: "Preis / Hinweis",
  registration: "Anmeldung",
  maps_url: "Maps-URL",
  image_url: "Bild"
};

const FORM_REVIEW_FIELDS = [
  { key: "title", required: true },
  { key: "description" },
  { key: "date", required: true },
  { key: "time" },
  { key: "time_end" },
  { key: "location", required: true },
  { key: "category" },
  { key: "age_group" },
  { key: "contact" },
  { key: "opening_hours" },
  { key: "price_info" },
  { key: "registration" },
  { key: "maps_url" },
  { key: "image_url" }
];

function labelForField(key){
  return OCR_FIELD_LABELS[key] || key;
}

function openFormForOcr(){
  if (choiceBox) choiceBox.classList.add("hidden");
  if (form) form.classList.remove("hidden");
  steps.forEach((s,i)=>s.classList.toggle("hidden", i!==0));
  currentStep = 0;
}

function setOcrStatus(message, tone="info"){
  if (!ocrStatus) return;
  const tones = {
    info: "text-gray-700",
    warn: "text-amber-600",
    error: "text-red-600",
    success: "text-green-700",
  };
  ocrStatus.innerHTML = message || "";
  ocrStatus.classList.remove("text-gray-700","text-amber-600","text-red-600","text-green-700");
  ocrStatus.classList.add(tones[tone] || tones.info);
  if (message) ocrPanel?.classList.remove("hidden");
}

function setOcrConfidence(confObj){
  if (!ocrConf) return;
  const text = renderConfidence(confObj || {});
  ocrConf.textContent = text;
  if (text) ocrConf.classList.remove("hidden");
  else ocrConf.classList.add("hidden");
}

function formatReadable(dateStr, timeStr, timeEndStr) {
  if (!dateStr) return "Datum unbekannt";
  const base = new Date(`${dateStr}T09:00`);
  if (isNaN(base.getTime())) return "Datum unbekannt";
  const weekday = base.toLocaleDateString("de-DE", { weekday: "long" });
  const datePart = base.toLocaleDateString("de-DE");

  let timeText = "";
  if (timeStr) {
    const start = new Date(`${dateStr}T${timeStr}`);
    if (!isNaN(start.getTime())) {
      const startText = start.toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" }).replace(":00"," Uhr");
      if (timeEndStr) {
        const end = new Date(`${dateStr}T${timeEndStr}`);
        if (!isNaN(end.getTime())) {
          const endText = end.toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" }).replace(":00"," Uhr");
          timeText = `${startText} – ${endText}`;
        } else {
          timeText = startText;
        }
      } else {
        timeText = startText;
      }
    }
  }

  return `${weekday}${timeText ? ", " + timeText : ""} (${datePart})`;
}

function renderConfidence(confObj) {
  const vals = Object.values(confObj || {}).map(Number).filter(n => !isNaN(n));
  if (!vals.length) return "";
  const avg = Math.round(100 * vals.reduce((a,b)=>a+b,0) / vals.length);
  return `≈ Erkennungs-Sicherheit: ${avg}%`;
}

function setInvalid(el){ el.classList.add("border-red-500","ring-2","ring-red-300"); }
function clearInvalid(el){ el.classList.remove("border-red-500","ring-2","ring-red-300"); }
function markMissing(missing=[]) {
  const ids = ["title","description","date","time","time_end","location","category","age_group","maps_url","image_url"];
  ids.forEach(id => { const el=document.getElementById(id); if(el) clearInvalid(el); });
  missing.forEach(id => { const el=document.getElementById(id); if(el) setInvalid(el); });
}

function renderCategorySuggestions(list){
  if (!categorySuggestions) return;
  const cats = Array.isArray(list) ? [...new Set(list.filter(Boolean))] : [];
  detectedCategories = cats;
  categorySuggestions.innerHTML = "";
  if (!cats.length) {
    categorySuggestions.classList.add("hidden");
    return;
  }
  const label = document.createElement("span");
  label.className = "w-full text-[11px] uppercase tracking-wide text-lottina-primary font-semibold";
  label.textContent = "Erkannte Kategorien";
  categorySuggestions.appendChild(label);

  cats.slice(0, 6).forEach((name) => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "px-3 py-1 rounded-full border border-lottina-primary/40 text-lottina-primary text-xs sm:text-sm hover:bg-lottina-primary hover:text-white transition focus:outline-none focus:ring-2 focus:ring-lottina-primary";
    btn.textContent = name;
    btn.addEventListener("click", () => {
      const input = document.getElementById("category");
      if (!input) return;
      input.value = name;
      const inputEvt = new Event("input", { bubbles: true });
      input.dispatchEvent(inputEvt);
      renderOcrReview();
    });
    categorySuggestions.appendChild(btn);
  });
  categorySuggestions.classList.remove("hidden");
}

function readFieldValue(id){
  const el = document.getElementById(id);
  if (!el) return "";
  if (el.tagName === "SELECT") return el.value;
  if (el.type === "checkbox") return el.checked ? "true" : "";
  return typeof el.value === "string" ? el.value.trim() : el.value;
}

function formatDateForReview(value){
  if (!value) return "";
  const d = new Date(value);
  if (!Number.isNaN(d.valueOf())) return d.toLocaleDateString("de-DE");
  const m = value.match(/(\d{1,2})\.(\d{1,2})\.(\d{2,4})/);
  if (m) return `${m[1].padStart(2,"0")}.${m[2].padStart(2,"0")}.${m[3].length===2?"20"+m[3]:m[3]}`;
  return value;
}

function formatTimeForReview(value){
  if (!value) return "";
  const match = value.match(/^(\d{1,2}):(\d{2})$/);
  if (match) return `${match[1].padStart(2,"0")}:${match[2]}`;
  const alt = value.match(/(\d{1,2})\.(\d{2})/);
  if (alt) return `${alt[1].padStart(2,"0")}:${alt[2]}`;
  return value;
}

function formatReviewValue(key, raw){
  if (raw === undefined || raw === null) return "";
  const value = typeof raw === "string" ? raw.trim() : raw;
  if (value === "") return "";

  if (key === "date") return formatDateForReview(value);
  if (key === "time" || key === "time_end") return formatTimeForReview(value);
  if (key === "registration") {
    const low = String(value).toLowerCase();
    if (low === "ja" || low === "yes" || low === "true") return "Ja";
    if (low === "nein" || low === "no" || low === "false") return "Nein";
    return value;
  }

  return value;
}

function createLinkValue(href, label){
  const wrapper = document.createElement("div");
  const a = document.createElement("a");
  a.href = href;
  a.target = "_blank";
  a.rel = "noopener noreferrer";
  a.className = "text-sky-600 underline break-words";
  a.title = href;
  a.textContent = label || href;
  wrapper.appendChild(a);
  return wrapper;
}

function focusFieldFromReview(key){
  const el = document.getElementById(key);
  if (!el || el.type === "hidden") {
    if (key === "image_url") {
      const img = document.getElementById("ocrImagePreviewImg");
      if (img?.src) window.open(img.src, "_blank", "noopener");
    }
    return;
  }
  const prevShadow = el.style.boxShadow;
  el.scrollIntoView({ behavior: "smooth", block: "center" });
  try { el.focus({ preventScroll: true }); } catch (_) { try { el.focus(); } catch (_) {} }
  el.style.boxShadow = "0 0 0 3px rgba(251, 92, 79, 0.35)";
  setTimeout(() => {
    el.style.boxShadow = prevShadow;
  }, 1200);
}

function renderOcrReview(){
  if (!reviewGrid || !reviewBox) return;

  reviewGrid.innerHTML = "";
  let filled = 0;

  FORM_REVIEW_FIELDS.forEach(({ key, required }) => {
    const originalEl = document.getElementById(key);
    const rawValue = originalEl && originalEl.value != null ? originalEl.value : readFieldValue(key);
    const display = formatReviewValue(key, rawValue);
    const isFilled = display !== "" && display !== undefined && display !== null;
    if (isFilled) filled += 1;

    const isEditing = activeReviewEdit === key;

    const item = document.createElement("div");
    item.className = "rounded-xl border px-3 py-2 text-sm shadow-sm bg-white";
    item.dataset.field = key;
    if (isEditing) {
      item.classList.add("border-lottina-primary/50","bg-white");
    } else if (isFilled) {
      item.classList.add("border-emerald-200","bg-emerald-50");
    } else {
      item.classList.add(required ? "border-red-200" : "border-amber-200");
      item.classList.add(required ? "bg-red-50" : "bg-amber-50");
    }

    const interactive = key !== "image_url" || Boolean(display);
    if (interactive) {
      item.classList.add("cursor-pointer");
      item.tabIndex = 0;
      item.setAttribute("role", "button");
    }

    const labelEl = document.createElement("div");
    labelEl.className = "text-[11px] font-semibold uppercase tracking-wide text-gray-500 flex items-center gap-2";
    labelEl.textContent = labelForField(key);
    if (required) {
      const badge = document.createElement("span");
      badge.className = "text-[10px] font-bold text-red-500";
      badge.textContent = "*";
      labelEl.appendChild(badge);
    }

    const valueEl = document.createElement("div");
    valueEl.className = "text-gray-900 whitespace-pre-line";

    if (isFilled) {
      if (key === "maps_url") {
        valueEl.replaceChildren(createLinkValue(display, display));
      } else if (key === "contact" && /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(display)) {
        valueEl.replaceChildren(createLinkValue(`mailto:${display}`, display));
      } else if (key === "image_url") {
        const label = display ? "Bild ansehen" : display;
        valueEl.replaceChildren(createLinkValue(display, label));
      } else {
        valueEl.textContent = display;
      }
    } else {
      const missingText = document.createElement("span");
      missingText.className = required ? "text-red-600 font-medium" : "text-amber-700";
      missingText.textContent = required ? "Pflichtfeld fehlt" : "Noch offen";
      valueEl.appendChild(missingText);
    }

    item.appendChild(labelEl);
    item.appendChild(valueEl);

    item.addEventListener("click", () => handleReviewItemAction(key));
    item.addEventListener("keydown", (ev) => {
      if (ev.key === "Enter" || ev.key === " ") {
        ev.preventDefault();
        handleReviewItemAction(key);
      }
    });
    reviewGrid.appendChild(item);
  });

  if (reviewStats) {
    const total = FORM_REVIEW_FIELDS.length;
    reviewStats.textContent = `${filled}/${total} Felder ausgefüllt`;
  }

  reviewBox.classList.remove("hidden");
}

document.getElementById("previewBtn")?.addEventListener("click", () => {
  const previewData = {
    title: document.getElementById("title").value || "Ohne Titel",
    description: document.getElementById("description")?.value || "",
    date: document.getElementById("date").value,
    time: document.getElementById("time").value,
    time_end: document.getElementById("time_end").value,
    location: document.getElementById("location").value,
    category: document.getElementById("category").value,
    age_group: document.getElementById("age_group").value,
    contact: document.getElementById("contact").value,
    opening_hours: document.getElementById("opening_hours").value,
    price_info: document.getElementById("price_info").value,
    registration: document.getElementById("registration").value,
    maps_url: document.getElementById("maps_url").value,
    image_url: document.getElementById("image_url").value
  };

  renderPreview(previewData);
  document.getElementById("previewModal").classList.remove("hidden");
});
document.getElementById("closePreview")?.addEventListener("click", () => {
  document.getElementById("previewModal").classList.add("hidden");
});
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") document.getElementById("previewModal").classList.add("hidden");
});

function renderPreview(ev) {
  const fallbackImg = document.getElementById("ocrImagePreviewImg")?.src || "";
  const imgSrc = ev.image_url || fallbackImg;
  const readable = formatReadable(ev.date, ev.time, ev.time_end);
  const badges = [];
  if (ev.category) badges.push(`<span class="bg-white/90 text-lottina-primary px-3 py-1 rounded-full font-medium shadow-sm">${escapeHtml(ev.category)}</span>`);
  if (ev.age_group) badges.push(`<span class="bg-white/90 text-lottina-primary px-3 py-1 rounded-full font-medium shadow-sm">${escapeHtml(ev.age_group)}</span>`);

  const detailItems = [];
  if (ev.price_info) detailItems.push(`<li><strong>Preis:</strong> ${escapeHtml(ev.price_info)}</li>`);
  if (ev.registration) detailItems.push(`<li><strong>Anmeldung:</strong> ${escapeHtml(formatReviewValue("registration", ev.registration))}</li>`);
  if (ev.contact) {
    const safeContact = escapeHtml(ev.contact);
    const link = /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(ev.contact)
      ? `<a class="text-sky-600 underline" href="mailto:${safeContact}">${safeContact}</a>`
      : safeContact;
    detailItems.push(`<li><strong>Kontakt:</strong> ${link}</li>`);
  }
  if (ev.opening_hours) detailItems.push(`<li><strong>Öffnungszeiten:</strong> ${escapeHtml(ev.opening_hours)}</li>`);
  const detailBlock = detailItems.length
    ? `
      <section class="mb-8 text-sm text-gray-700 dark:text-gray-300">
        <ul class="space-y-1">
          ${detailItems.join("")}
        </ul>
      </section>`
    : "";

  const imgBlock = imgSrc
    ? `
    <div class="preview-img-wrap shadow border border-white/40">
      <div class="preview-ar">
        <img src="${escapeHtml(imgSrc)}" alt="${escapeHtml(ev.title)}" class="w-full h-full object-contain" />
      </div>
    </div>`
    : `
    <div class="preview-img-wrap shadow border border-dashed border-white/30 flex items-center justify-center text-gray-500 dark:text-gray-300">
      <div class="preview-ar flex items-center justify-center">
        <span class="px-3 text-sm">Kein Bild verfügbar</span>
      </div>
    </div>`;

  const mapsBlock = ev.maps_url ? `
      <section class="mb-12">
        <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-3">Anfahrt</h2>
        <iframe src="${escapeHtml(ev.maps_url)}" class="w-full h-64 rounded-xl border dark:border-gray-700 shadow"
          allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
      </section>` : ``;

  const html = `
      <main class="mx-auto px-2 pt-2 pb-10">
        ${imgBlock}
        <div class="mb-4">
          <h1 class="text-3xl font-bold text-lottina-primary dark:text-white">${escapeHtml(ev.title)}</h1>
          <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
            ${escapeHtml(readable)} – ${escapeHtml(ev.location || "Ort unbekannt")}
          </p>
        </div>
        <div class="flex flex-wrap gap-2 text-sm mb-6">${badges.join("")}</div>

        ${ev.description ? `
        <section class="mb-8 prose dark:prose-invert">
          <h2>Details</h2>
          <p>${escapeHtml(ev.description)}</p>
        </section>` : ``}

        ${detailBlock}

        ${mapsBlock}
      </main>
    `;
  document.getElementById("previewBody").innerHTML = html;
}

function escapeHtml(s) {
  if (!s) return "";
  return String(s)
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
}

function handleReviewItemAction(key){
  if (key === "image_url") {
    focusFieldFromReview(key);
    return;
  }

  const originalEl = document.getElementById(key);
  const rawValue = originalEl && originalEl.value != null ? originalEl.value : readFieldValue(key);
  if (activeReviewEdit === key && !reviewEditModal?.classList.contains("hidden")) {
    cancelReviewEdit();
    return;
  }
  activeReviewEdit = key;
  activeReviewDraft = rawValue ?? "";
  reviewEditOriginalEl = originalEl;
  renderOcrReview();
  openReviewEditorModal(key, originalEl, rawValue ?? "");
}

function buildReviewEditorControl(key, originalEl, rawValue){
  const type = inferEditorType(originalEl, key);
  let control;
  if (type === "textarea") {
    control = document.createElement("textarea");
    control.rows = 6;
  } else {
    control = document.createElement("input");
    control.type = type;
    if (type === "time" && rawValue && rawValue.length === 5) {
      control.step = "60";
    }
  }
  control.dataset.editorControl = "true";
  control.className = "w-full px-3 py-2 border border-gray-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-lottina-primary focus:border-lottina-primary";
  control.value = (activeReviewDraft ?? rawValue ?? "").toString();
  if (originalEl?.placeholder) control.placeholder = originalEl.placeholder;
  control.addEventListener("input", (ev) => {
    activeReviewDraft = ev.target.value;
  });
  control.addEventListener("keydown", (ev) => {
    if (ev.key === "Enter" && (control.tagName !== "TEXTAREA" || ev.metaKey || ev.ctrlKey)) {
      ev.preventDefault();
      saveReviewEdit(activeReviewEdit, reviewEditOriginalEl, control);
    } else if (ev.key === "Escape") {
      ev.preventDefault();
      cancelReviewEdit();
    }
  });
  return control;
}

function openReviewEditorModal(key, originalEl, rawValue){
  if (!reviewEditModal || !reviewEditBody) return;
  reviewEditBody.innerHTML = "";
  reviewEditTitle.textContent = labelForField(key);

  const helper = document.createElement("div");
  helper.className = "text-xs text-gray-500 mb-2";
  helper.textContent = "Direkt anpassen und übernehmen.";
  reviewEditBody.appendChild(helper);

  reviewEditControl = buildReviewEditorControl(key, originalEl, rawValue ?? "");
  reviewEditBody.appendChild(reviewEditControl);

  reviewEditModal.classList.remove("hidden");
  requestAnimationFrame(() => {
    if (reviewEditControl) {
      reviewEditControl.focus();
      if (typeof reviewEditControl.select === "function" && reviewEditControl.tagName !== "TEXTAREA") {
        reviewEditControl.select();
      }
    }
  });
}

function closeReviewEditorModal(){
  if (!reviewEditModal) return;
  reviewEditModal.classList.add("hidden");
  if (reviewEditBody) reviewEditBody.innerHTML = "";
  reviewEditControl = null;
  reviewEditOriginalEl = null;
}

function inferEditorType(originalEl, key){
  if (originalEl) {
    if (originalEl.tagName === "TEXTAREA") return "textarea";
    const attrType = originalEl.getAttribute("type");
    if (attrType) return attrType;
  }
  if (key === "date") return "date";
  if (key === "time") return "time";
  if (key === "time_end") return "time";
  if (key === "maps_url") return "url";
  return "text";
}

function saveReviewEdit(key, originalEl, control){
  const newValue = (control.value ?? "").toString();
  const target = originalEl || document.getElementById(key);
  if (target && "value" in target) {
    target.value = newValue;
    const inputEvt = new Event("input", { bubbles: true });
    const changeEvt = new Event("change", { bubbles: true });
    target.dispatchEvent(inputEvt);
    target.dispatchEvent(changeEvt);
  } else {
    setVal(key, newValue);
  }
  if (typeof control.blur === "function") control.blur();
  activeReviewEdit = null;
  activeReviewDraft = "";
  renderOcrReview();
  renderCategorySuggestions(detectedCategories);
  closeReviewEditorModal();
}

function cancelReviewEdit(){
  activeReviewEdit = null;
  activeReviewDraft = "";
  closeReviewEditorModal();
  renderOcrReview();
  renderCategorySuggestions(detectedCategories);
}

function gotoStep(i){
  i = Math.max(0, Math.min(i, steps.length-1));
  steps[currentStep].classList.add("hidden");
  steps[i].classList.remove("hidden");
  currentStep = i;
}

function setVal(id, v){
  const el = document.getElementById(id);
  if (!el) return;
  el.value = v ?? "";
}
function toHtmlDate(s){ if(!s) return ""; const m = String(s).match(/(\d{4})-(\d{2})-(\d{2})/); if(m) return `${m[1]}-${m[2]}-${m[3]}`; const d = String(s).match(/(\d{1,2})\.(\d{1,2})\.(\d{2,4})/); if(!d) return ""; let [_,dd,mm,yy]=d; if(yy.length===2) yy="20"+yy; return `${yy.padStart(4,"0")}-${mm.padStart(2,"0")}-${dd.padStart(2,"0")}`; }
function toHtmlTime(s){ if(!s) return ""; const t=String(s).replace("Uhr","").trim().replace(".",":"); const m=t.match(/^(\d{1,2}):(\d{2})$/); return m?`${m[1].padStart(2,"0")}:${m[2]}`:""; }
function showPreviewImg(src){
  const wrap = document.getElementById("ocrImagePreview");
  const img = document.getElementById("ocrImagePreviewImg");
  const hiddenInput = document.getElementById("image_url");
  if (hiddenInput) hiddenInput.value = src || "";
  if (!wrap || !img) return;
  if (src) {
    img.src = src;
    wrap.classList.remove("hidden");
  } else {
    img.src = "";
    wrap.classList.add("hidden");
  }
}

const ocrOverlay = document.getElementById("ocrOverlay");
function showOcrOverlay(msg="Erkenne Text…"){ document.getElementById("ocrOverlayMsg").textContent = msg; ocrOverlay.classList.remove("hidden"); }
function hideOcrOverlay(){ ocrOverlay.classList.add("hidden"); }

reviewEditSave?.addEventListener("click", () => {
  if (activeReviewEdit && reviewEditControl) {
    saveReviewEdit(activeReviewEdit, reviewEditOriginalEl, reviewEditControl);
  }
});
reviewEditCancel?.addEventListener("click", () => cancelReviewEdit());
reviewEditClose?.addEventListener("click", () => cancelReviewEdit());
reviewEditModal?.addEventListener("click", (e) => {
  if (e.target === reviewEditModal || (reviewEditOverlay && e.target === reviewEditOverlay)) {
    cancelReviewEdit();
  }
});

document.getElementById("ocrUpload")?.addEventListener("change", async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;

  markMissing([]);
  document.getElementById("ocrCandidateList")?.remove();
  setOcrConfidence(null);
  setOcrStatus(`<span class="font-medium">Analysiere:</span> ${escapeHtml(file.name || "Datei")} …`, "info");
  ocrPanel?.classList.remove("hidden");
  showOcrOverlay("Analysiere Datei …");

  const fd = new FormData();
  fd.append("file", file);

  try {
    const res = await fetch("/ocr/upload", { method:"POST", body: fd });
    const data = await res.json().catch(() => null);
    if (!res.ok || !data || data.ok === false) {
      const msg = data?.error || "OCR fehlgeschlagen. Bitte versuche es erneut.";
      setOcrStatus(escapeHtml(msg), "error");
      setOcrConfidence(null);
      return;
    }
    handleOcrResponse(data);
  } catch (err) {
    console.error("OCR-Upload fehlgeschlagen", err);
    setOcrStatus("Die Datei konnte nicht analysiert werden. Bitte versuche es erneut.", "error");
    setOcrConfidence(null);
  } finally {
    hideOcrOverlay();
    e.target.value = "";
  }
});

FORM_REVIEW_FIELDS.forEach(({ key }) => {
  const el = document.getElementById(key);
  if (!el) return;
  const evt = el.tagName === "SELECT" ? "change" : "input";
  el.addEventListener(evt, () => {
    renderOcrReview();
  });
});

renderOcrReview();
</script>
<script>
// --- Prefill-Helfer, falls mehrere Kandidaten erkannt wurden ---
function prefillFrom(fields, imageOverride) {
  setVal("title", fields.title);
  setVal("description", fields.description);
  setVal("date", toHtmlDate(fields.date));
  setVal("time", toHtmlTime(fields.time));
  setVal("time_end", toHtmlTime(fields.time_end));
  setVal("location", fields.location);
  setVal("category", fields.category);
  setVal("age_group", fields.age_group);
  setVal("contact", fields.contact);
  setVal("opening_hours", fields.opening_hours);
  setVal("price_info", fields.price_info);
  setVal("registration", fields.registration ? fields.registration.toLowerCase() : "");
  setVal("maps_url", fields.maps_url);
  renderCategorySuggestions(fields.categories);
  const imgSrc = imageOverride ?? fields.image_url;
  showPreviewImg(imgSrc);
  activeReviewEdit = null;
  activeReviewDraft = "";
  renderOcrReview();
}

function handleOcrResponse(data) {
  if (!data) {
    setOcrStatus("Keine Daten vom OCR-Dienst erhalten.", "error");
    setOcrConfidence(null);
    return;
  }

  if (data.ok === false) {
    setOcrStatus(escapeHtml(data.error || "OCR fehlgeschlagen."), "error");
    setOcrConfidence(null);
    return;
  }

  const fields = data.fields || {};
  const imageUrl = data.image_url || fields.image_url;
  prefillFrom(fields, imageUrl);

  openFormForOcr();

  const missing = Array.isArray(data.missing) ? data.missing : [];
  markMissing(missing);
  renderOcrReview();

  const foundRaw = Array.isArray(data.found) ? data.found : Object.keys(fields).filter((key) => fields[key]);
  const uniqueFound = [...new Set(foundRaw)];
  const toLabel = (key) => escapeHtml(labelForField(key));

  const foundText = uniqueFound.length
    ? `<span class="font-semibold text-green-700">Erkannt:</span> ${uniqueFound.map(toLabel).join(", ")}`
    : "Keine Felder automatisch erkannt.";

  let tone = "success";
  let message = `<div>${foundText}</div>`;
  if (missing.length) {
    tone = "warn";
    message += `<div class="mt-1"><span class="font-semibold">Fehlend:</span> ${missing.map(toLabel).join(", ")}</div>`;
  } else {
    message += `<div class="mt-1">Alle Pflichtfelder wurden erkannt.</div>`;
  }
  setOcrStatus(message, tone);
  setOcrConfidence(data.confidence);

  document.getElementById("ocrCandidateList")?.remove();
  const candidates = Array.isArray(data.candidates) ? data.candidates : [];
  if (candidates.length > 1) {
    const host = document.createElement("div");
    host.id = "ocrCandidateList";
    host.className = "mt-4 border-t pt-3";
    host.innerHTML = `<div class="text-sm font-semibold mb-2">Mehrere Events erkannt – wähle eines aus:</div>`;
    candidates.slice(0, 6).forEach((c) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "block w-full text-left px-3 py-2 mb-2 rounded-lg border hover:bg-gray-50";
      const btnLabel = `${c.title || "Ohne Titel"} — ${c.date || "Datum unbekannt"} — ${c.location || "Ort ?"}`;
      btn.textContent = btnLabel;
      btn.addEventListener("click", () => {
        prefillFrom(c, c.image_url);
        markMissing([]);
        setOcrStatus(`<div class="font-semibold">Kandidat übernommen.</div><div>${escapeHtml(btnLabel)}</div>`, "success");
        if (c.confidence) setOcrConfidence({ avg: c.confidence });
        renderOcrReview();
        gotoStep(steps.length - 1);
      });
      host.appendChild(btn);
    });
    ocrPanel.appendChild(host);
  }

  gotoStep(steps.length - 1);
}
</script>
<script>
// --- Wizard Navigation ---
const startManualBtn = document.getElementById("startManual");
const nextBtn        = document.getElementById("nextStep");
const prevBtn        = document.getElementById("prevStep");
const submitBtn      = document.getElementById("submitEvent");

function updateButtons(){
  prevBtn.classList.toggle("hidden", currentStep === 0);
  const isLast = currentStep === (steps.length - 1);
  nextBtn.classList.toggle("hidden",  isLast);
  submitBtn.classList.toggle("hidden", !isLast);
}

startManualBtn?.addEventListener("click", () => {
  choiceBox.classList.add("hidden");
  form.classList.remove("hidden");
  steps.forEach((s,i)=>s.classList.toggle("hidden", i!==0));
  currentStep = 0;
  updateButtons();
});

nextBtn?.addEventListener("click", () => {
  const req = steps[currentStep].querySelectorAll("[required]");
  let ok = true;
  req.forEach(el => {
    if (!el.value) { ok = false; el.classList.add("border-red-500","ring-2","ring-red-300"); }
    else { el.classList.remove("border-red-500","ring-2","ring-red-300"); }
  });
  if (!ok) return;

  if (currentStep < steps.length - 1) {
    gotoStep(currentStep + 1);
    updateButtons();
  } else {
    form.submit();
  }
});

prevBtn?.addEventListener("click", () => {
  if (currentStep > 0) {
    gotoStep(currentStep - 1);
    updateButtons();
  }
});

const _origGotoStep = gotoStep;
gotoStep = function(i){
  _origGotoStep(i);
  updateButtons();
};

document.getElementById("ocrUpload")?.addEventListener("change", () => {
  updateButtons();
});
</script>

{% endblock %}
